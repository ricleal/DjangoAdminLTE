{% extends "base.html" %}
{% load staticfiles %}
{% load humanize %}

{% block head %}
<!-- DataTables -->
<link rel="stylesheet"
	href="{% static 'AdminLTE_plugins/datatables/dataTables.bootstrap.css' %}">
<!-- Our internal functions -->
<script src="{% static 'js/sns.js' %}"></script>
<!-- handsontable -->
<link
	href="https://cdnjs.cloudflare.com/ajax/libs/handsontable/0.20.3/handsontable.full.min.css"
	rel="stylesheet">
<script
	src="https://cdnjs.cloudflare.com/ajax/libs/handsontable/0.20.3/handsontable.full.min.js"></script>

<!--   jquery-ui for auto complete-->
<link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/themes/smoothness/jquery-ui.css">

{% endblock head %}

{% block content %}

<!-- Content Header (Page header) -->
<section class="content-header">
	<h1>
		Reduction <small>{{ object.id }}</small>
	</h1>
	<ol class="breadcrumb">
		<li class="active">Reduction</li>
		<li>{{ instrument|default:request.user.profile.instrument }}</li>
		<li>{{ object }}</li>
	</ol>
</section>

<!-- Main content -->

<section class="content">
	<div class="row">
		<!-- left column -->
		<div class="col-md-12">
			<!-- general form elements -->
			<div class="box box-primary">
				<div class="box-header with-border">
					<h3 class="box-title">Reduction Form</h3>
				</div>
				<!-- /.box-header -->
				<!-- form start -->
				<form role="form" action="" method="post" onsubmit="return load_table();">
					{% csrf_token %}
					<div class="box-body">{{ form.as_p }}</div>
					<!-- /.box-body -->
					
					<div class="box-body"><div id="entries"></div></div>
					<input type="hidden" id="entries_hidden" name="entries_hidden" value="">
					
					<div class="box-footer">
						<button type="button" class="btn btn-default">Cancel</button>
						{% if form.instance.pk %}
						<button type="submit" class="btn btn-primary">Update</button>
						{% else %}
						<button type="submit" class="btn btn-primary">Save</button>
						{% endif %}
					</div>
				</form>
			</div>
			<!-- /.box -->
		</div>
	</div>
</section>

<script>
	//Initial data
	var headers = {{entry_headers | safe}};
	{% if entries %}
		var data = {{entries|safe}};
	{% else %}
		// Empty data
		var data = [new Array(headers.length).join(".").split(".")];
	{% endif %}


	// Populates the table
	var container = document.getElementById('entries');
	var hot = new Handsontable(container, {
		data: data,
		height: 300,
		minSpareRows: 10,
		stretchH: 'all',
	    columnSorting: true,
	    contextMenu: true,
	    autoWrapRow: true,
		rowHeaders : false,
		colHeaders : headers,
		contextMenu : true,
		columns:
	        [{% for name in entry_names %}  
	            	{ data: "{{name}}" }{% if not forloop.last %},{% endif %}
	            {% endfor %}]
	});
	
	// Emitts alerts if one of the elements in the row is empty and the other non empty
	function rowHasEmptyElements(row){
	    var empty = 0;
	    var full = 0;
	    for (var i = 0; i < row.length; i++) {
	        if (row[i] == null || row[i] == "") empty++;
	        else full++;
	    }
	    if (empty > 0 && full > 0){
	        alert("Rows must be full!\n" + row);
	    	return true;
	    } else
	    	return false;
	    
	}

	// Put in the form the hidden field entries_hidden with the table contents
	// Used when updating or saving the table to pass table contents to django
    function load_table() {
		// Some validation!
		var data = hot.getData();
		for (var i = 0; i < data.length; i++) {
			if (rowHasEmptyElements(data[i])) return false;
		}
    	document.getElementById('entries_hidden').value = JSON.stringify(data);
    	console.log(document.getElementById('entries_hidden').value);
        return true;
     }
	
	
</script>

<!-- /.content -->
{% endblock %}

{% block body_end %}
<!-- page script -->

<!--   jquery-ui for auto complete-->
<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/jquery-ui.min.js"></script>

<script>
/* Call autocomplete functions on load */
$(function(){
	set_autocomplete("#id_ipts", "{% url 'catalog:list_iptss_json' instrument=request.user.profile.instrument.icat_name|upper %}");
});
</script>
<script>
<!-- Admin LTE requires these classes for better forms -->
	$("input").addClass("form-control");
	$("select").addClass("form-control");

</script>
{% endblock body_end %}
